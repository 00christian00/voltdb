package pmsg;
option java_package = "org.voltdb.pmsg";
option java_outer_classname = "DRAgent";

message Ack {
    optional int32 partitionId = 1;
    optional fixed64 timestamp = 2;
}

message SnapshotReq {
    optional string nonce = 1;
}

message Reset {
    optional int32 partitionId = 1;
    optional fixed64 timestamp = 2;
}

message Pause {
    optional int32 partitionId = 1;
}

message Response {
    enum ReplicationMode {
        IDLE = 1;
        SYNCING_REPLICATED = 2;
        SYNCING_PARTITIONED = 3;
        ACTIVE = 4;
        UNAVAILABLE = 5;
    }
    optional ReplicationMode mode = 1;
    optional fixed64 snapshotTimestamp = 2;
    optional fixed64 instanceIdHash = 3;
    optional string version = 4;
    // all known nodes globally
    //  first entry is self
    repeated NodeInfo nodeInfo = 5;
    optional int32 globalPartitionCount = 6;
    // local partitions
    repeated PartitionInfo partitionInfo = 7;
    // status. 0 means ok
    optional int32 status = 8 [default = 0];
}

message NodeInfo {
    optional string hostname = 1;
    optional int32 drport = 2;
    optional fixed64 catalogCRC = 3;
}

message PartitionInfo {
    optional int32 partitionId = 1;

    // info for active replication
    optional fixed64 oldestTimestamp = 2;
    optional fixed64 lastSentTimestamp = 3;

    // info for syncing snapshots
    optional int64 lowestTupleIndex = 4;
    optional int64 lastSentTupleIndex = 5;
    optional int64 totalTupleCount = 6;

    // common info
    optional int64 outstandingBufferCount = 7;
    optional int64 outstandingByteCount = 8;
    optional bool isPaused = 9;
    optional bool isSynced = 10;
}

message CtrlEnvelope {
    enum Type {
        ACK = 1;
        RESET = 2;
        PAUSE = 3;
        QUERY = 4;
        RESPONSE = 5;
        SNAPSHOT_REQ = 6;
        STOP_SYNC = 7;
    }
    required Type type = 1;
    optional Ack ack = 2;
    optional Reset reset = 3;
    optional Pause pause = 4;
    optional Response response = 5;
    optional SnapshotReq snapshotReq = 6;
}
