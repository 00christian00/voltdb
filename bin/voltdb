#!/usr/bin/env bash

bin=`dirname "$0"`
bin=`cd "$bin"; pwd`

# resolve links - $0 may be a softlink

this="$0"
while [ -h "$this" ]; do
  ls=`ls -ld "$this"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '.*/.*' > /dev/null; then
    this="$link"
  else
    this=`dirname "$this"`/"$link"
  fi
done

# convert relative path to absolute path
bin=`dirname "$this"`
script=`basename "$this"`
bin=`cd "$bin"; pwd`
this="$bin/$script"

# the root of the VoltDB installation
export VOLTDB_HOME=`dirname "$this"`/..
#echo $VOLTDB_HOME

JAVA=`which java`
JAVA_HEAP_MAX=-Xmx1024m

# some Java parameters
if [ "$JAVA_HOME" != "" ]; then
  #echo "run java in $JAVA_HOME"
  JAVA=$JAVA_HOME/bin/java
fi

# check envvars which might override default args
if [ -n "${VOLTDB_HEAPSIZE:+x}" ]; then
  #echo "run with heapsize $VOLTDB_HEAPSIZE"
  JAVA_HEAP_MAX="-Xmx""$VOLTDB_HEAPSIZE""m"
else
  JAVA_HEAP_MAX="-Xmx1024m"
fi
#echo $JAVA_HEAP_MAX

# check envvars to see if a user overrides log4j conf
if [ -n "${LOG4J_CONFIG_PATH:-x}" ]; then
  if [ -f "$VOLTDB_HOME/src/frontend/log4j.xml" ]; then
    LOG4J_CONFIG_PATH=$VOLTDB_HOME/src/frontend/log4j.xml
  elif [ -f "$VOLTDB_HOME/voltdb/log4j.xml" ]; then
    LOG4J_CONFIG_PATH=$VOLTDB_HOME/voltdb/log4j.xml
  else
    echo "Couldn't find log4j configuration file."
    exit 1
  fi
fi

if [ -d "$VOLTDB_HOME/obj/release/prod" ]; then
  CLASSPATH=$VOLTDB_HOME/obj/release/prod:$VOLTDB_HOME/third_party/java/obj
  for f in $VOLTDB_HOME/third_party/java/jars/*.jar; do
    CLASSPATH=${CLASSPATH}:$f;
  done
elif [ -d "$VOLTDB_HOME/obj/debug/prod" ]; then
  CLASSPATH=$VOLTDB_HOME/obj/debug/prod:$VOLTDB_HOME/third_party/java/obj
  for f in $VOLTDB_HOME/third_party/java/jars/*.jar; do
    CLASSPATH=${CLASSPATH}:$f;
  done
elif [ -f "$VOLTDB_HOME/voltdb/voltdb-2.0.jar" ]; then
  CLASSPATH=$VOLTDB_HOME/voltdb/voltdb-2.0.jar
else
  echo "Couldn't find compiled VoltDB to run."
  exit 1
fi

if [ -d "$VOLTDB_HOME/obj/release/nativelibs" ]; then
  JAVA_LIBRARY_PATH=${VOLTDB_HOME}/obj/release/nativelibs
elif [ -d "$VOLTDB_HOME/voltdb" ]; then
  JAVA_LIBRARY_PATH=${VOLTDB_HOME}/voltdb
else
  echo "Couldn't find compiled VoltDB to run."
  exit 1
fi
#echo $JAVA_LIBRARY_PATH

# add libs to CLASSPATH
for f in $VOLTDB_HOME/lib/*.jar; do
  CLASSPATH=${CLASSPATH}:$f;
done

# run it
export CMDVAL="$JAVA -server -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp "
export CMDVAL=$CMDVAL"-XX:-ReduceInitialCardMarks $JAVA_HEAP_MAX $VOLTDB_OPTS "
export CMDVAL=$CMDVAL"-Dlog4j.configuration=file://${LOG4J_CONFIG_PATH} "
export CMDVAL=$CMDVAL"-Djava.library.path=${JAVA_LIBRARY_PATH} -classpath $CLASSPATH "
export CMDVAL=$CMDVAL"org.voltdb.VoltDB $@"
#echo $CMDVAL
exec $CMDVAL
